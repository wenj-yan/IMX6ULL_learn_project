## 16.高精度延时实验

硬件方式，而非循环延时

GPT定时器（通用目的定时器），精度可以到达15-20us

同EPIT功能：

- GPT是32位向上定时器，而EPIT是向下计数器。
- GPT定时器有捕获的功能。
- GPT定时器支持比较输出或者中断功能


**原理：**

如果设置 GPT 定时器的时钟源为 ipg_clk=66MHz，设置 66 分频，那么进入 GPT 定时器的最终时钟频率就是 66/66=1MHz，周期为 1us。GPT 的计数器每计一个数就表示“过去” 了 1us。如果计 10 个数就表示“过去”了 10us。通过读取寄存器 GPTx_CNT 中的值就知道计的个数，比如现在要延时100us，那么进入延时函数以后纪录下寄存器 GPTx_CNT中的值为 200， 当 GPTx_CNT 中的值为 300 的时候就表示 100us 过去了，也就是延时结束。GPTx_CNT 是个 32 位寄存器，如果时钟为 1MHz 的话，GPTx_CNT 最多可以实现0XFFFFFFFFus=4294967295us ≈4294s≈72min。也就是说 72 分钟以后 GPTx_CNT 寄存器就会回滚到 0X00000000，也就是溢出，所以需要在延时函数中要处理溢出的情况。

**实现步骤：**

1、**设置 GPT1 定时器**  首先设置 GPT1_CR 寄存器的 SWR(bit15)位来复位寄存器 GPT1。复位完成以后设置寄存 器 GPT1_CR 寄存器的 CLKSRC(bit8:6)位，选择 GPT1 的时钟源为 ipg_clk。设置定时器 GPT1 的工作模式，  

2、**设置 GPT1 的分频值**  设置寄存器 GPT1_PR 寄存器的 PRESCALAR(bit111:0)位，设置分频值。  

3、**设置 GPT1 的比较值** 如果要使用 GPT1 的输出比较中断，那么 GPT1 的输出比较寄存器 GPT1_OCR1 的值可以 根据所需的中断时间来设置。本章例程不使用比较输出中断，所以将 GPT1_OCR1 设置为最大 值，即：0XFFFFFFFF。  

4、**使能 GPT1 定时器**  设置好 GPT1 定时器以后就可以使能了，设置 GPT1_CR 的 EN(bit0)位为 1 来使能 GPT1 定时器。  

5、**编写延时函数**  GPT1定时器已经开始运行了，可以根据前面介绍的高精度延时函数原理来编写延时函数， 针对 us 和 ms 延时分别编写两个延时函数。